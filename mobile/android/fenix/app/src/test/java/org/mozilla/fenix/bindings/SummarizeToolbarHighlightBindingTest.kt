/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.fenix.bindings

import kotlinx.coroutines.test.StandardTestDispatcher
import kotlinx.coroutines.test.runTest
import mozilla.components.browser.state.action.TabListAction
import mozilla.components.browser.state.state.BrowserState
import mozilla.components.browser.state.state.createTab
import mozilla.components.browser.state.store.BrowserStore
import org.junit.Assert.assertFalse
import org.junit.Assert.assertTrue
import org.junit.Test
import org.mozilla.fenix.components.AppStore
import org.mozilla.fenix.components.appstate.SupportedMenuNotifications
import org.mozilla.fenix.settings.summarize.FakeSummarizeFeatureDiscoverySettings

class SummarizeToolbarHighlightBindingTest {

    private val testDispatcher = StandardTestDispatcher()

    @Test
    fun `GIVEN highlight is enabled and normal tab is selected THEN menu notification is added`() =
        runTest(testDispatcher) {
            val tab = createTab(url = "https://example.com", id = "tab1", private = false)
            val browserStore = BrowserStore(
                BrowserState(
                    tabs = listOf(tab),
                    selectedTabId = tab.id,
                ),
            )
            val appStore = AppStore()
            val settings = FakeSummarizeFeatureDiscoverySettings(
                expectedToolbarMenuButtonHighlight = true,
            )

            val binding = SummarizeToolbarHighlightBinding(
                appStore = appStore,
                featureDiscoverySettings = settings,
                browserStore = browserStore,
                mainDispatcher = testDispatcher,
            )
            binding.start()
            testDispatcher.scheduler.advanceUntilIdle()

            assertTrue(
                "Summarize notification should be added for normal tab with highlight enabled",
                appStore.state.supportedMenuNotifications.contains(SupportedMenuNotifications.Summarize),
            )
        }

    @Test
    fun `GIVEN highlight is disabled and normal tab is selected THEN menu notification is not added`() =
        runTest(testDispatcher) {
            val tab = createTab(url = "https://example.com", id = "tab1", private = false)
            val browserStore = BrowserStore(
                BrowserState(
                    tabs = listOf(tab),
                    selectedTabId = tab.id,
                ),
            )
            val appStore = AppStore()
            val settings = FakeSummarizeFeatureDiscoverySettings(
                expectedToolbarMenuButtonHighlight = false,
            )

            val binding = SummarizeToolbarHighlightBinding(
                appStore = appStore,
                featureDiscoverySettings = settings,
                browserStore = browserStore,
                mainDispatcher = testDispatcher,
            )
            binding.start()
            testDispatcher.scheduler.advanceUntilIdle()

            assertFalse(
                "Summarize notification should not be added when highlight is disabled",
                appStore.state.supportedMenuNotifications.contains(SupportedMenuNotifications.Summarize),
            )
        }

    @Test
    fun `GIVEN highlight is enabled and private tab is selected THEN menu notification is not added`() =
        runTest(testDispatcher) {
            val tab = createTab(url = "https://example.com", id = "tab1", private = true)
            val browserStore = BrowserStore(
                BrowserState(
                    tabs = listOf(tab),
                    selectedTabId = tab.id,
                ),
            )
            val appStore = AppStore()
            val settings = FakeSummarizeFeatureDiscoverySettings(
                expectedToolbarMenuButtonHighlight = true,
            )

            val binding = SummarizeToolbarHighlightBinding(
                appStore = appStore,
                featureDiscoverySettings = settings,
                browserStore = browserStore,
                mainDispatcher = testDispatcher,
            )
            binding.start()
            testDispatcher.scheduler.advanceUntilIdle()

            assertFalse(
                "Summarize notification should not be added for private tab",
                appStore.state.supportedMenuNotifications.contains(SupportedMenuNotifications.Summarize),
            )
        }

    @Test
    fun `GIVEN highlight is enabled and normal tab is selected WHEN switching to private tab THEN menu notification is removed`() =
        runTest(testDispatcher) {
            val normalTab =
                createTab(url = "https://example.com", id = "normalTab", private = false)
            val privateTab =
                createTab(url = "https://private.com", id = "privateTab", private = true)
            val browserStore = BrowserStore(
                BrowserState(
                    tabs = listOf(normalTab, privateTab),
                    selectedTabId = normalTab.id,
                ),
            )
            val appStore = AppStore()
            val settings = FakeSummarizeFeatureDiscoverySettings(
                expectedToolbarMenuButtonHighlight = true,
            )

            val binding = SummarizeToolbarHighlightBinding(
                appStore = appStore,
                featureDiscoverySettings = settings,
                browserStore = browserStore,
                mainDispatcher = testDispatcher,
            )
            binding.start()
            testDispatcher.scheduler.advanceUntilIdle()

            browserStore.dispatch(TabListAction.SelectTabAction(privateTab.id))
            testDispatcher.scheduler.advanceUntilIdle()

            assertFalse(
                "Summarize notification should be removed after switching to private tab",
                appStore.state.supportedMenuNotifications.contains(SupportedMenuNotifications.Summarize),
            )
        }

    @Test
    fun `GIVEN highlight is enabled and private tab is selected WHEN switching to normal tab THEN menu notification is added`() =
        runTest(testDispatcher) {
            val normalTab =
                createTab(url = "https://example.com", id = "normalTab", private = false)
            val privateTab =
                createTab(url = "https://private.com", id = "privateTab", private = true)
            val browserStore = BrowserStore(
                BrowserState(
                    tabs = listOf(normalTab, privateTab),
                    selectedTabId = privateTab.id,
                ),
            )
            val appStore = AppStore()
            val settings = FakeSummarizeFeatureDiscoverySettings(
                expectedToolbarMenuButtonHighlight = true,
            )

            val binding = SummarizeToolbarHighlightBinding(
                appStore = appStore,
                featureDiscoverySettings = settings,
                browserStore = browserStore,
                mainDispatcher = testDispatcher,
            )
            binding.start()
            testDispatcher.scheduler.advanceUntilIdle()

            browserStore.dispatch(TabListAction.SelectTabAction(normalTab.id))
            testDispatcher.scheduler.advanceUntilIdle()

            assertTrue(
                "Summarize notification should be added after switching to normal tab",
                appStore.state.supportedMenuNotifications.contains(SupportedMenuNotifications.Summarize),
            )
        }

    @Test
    fun `GIVEN no selected tab THEN menu notification is not added`() =
        runTest(testDispatcher) {
            val browserStore = BrowserStore(
                BrowserState(
                    tabs = emptyList(),
                    selectedTabId = null,
                ),
            )
            val appStore = AppStore()
            val settings = FakeSummarizeFeatureDiscoverySettings(
                expectedToolbarMenuButtonHighlight = true,
            )

            val binding = SummarizeToolbarHighlightBinding(
                appStore = appStore,
                featureDiscoverySettings = settings,
                browserStore = browserStore,
                mainDispatcher = testDispatcher,
            )
            binding.start()
            testDispatcher.scheduler.advanceUntilIdle()

            assertFalse(
                "Summarize notification should not be added when no tab is selected",
                appStore.state.supportedMenuNotifications.contains(SupportedMenuNotifications.Summarize),
            )
        }
}
